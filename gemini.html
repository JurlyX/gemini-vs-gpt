<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Puter.js Infinite Craft</title>
    <script src="https://js.puter.com/v2/"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #f0f0f0; margin: 0; padding: 20px; }
        #game-container { display: flex; width: 100%; max-width: 900px; gap: 20px; }
        #inventory, #crafting { flex: 1; min-height: 400px; border: 1px solid #ccc; padding: 10px; border-radius: 8px; background-color: #fff; overflow-y: auto; }
        #inventory h2, #crafting h2 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .element-item { padding: 8px 12px; margin: 5px; background-color: #e9e9e9; border-radius: 4px; cursor: grab; display: inline-block; font-weight: bold; }
        #result-box { margin-top: 20px; padding: 15px; border-radius: 8px; background-color: #333; color: white; text-align: center; width: 100%; max-width: 900px; }
    </style>
</head>
<body>

    <h1>Puter.js Infinite Craft Clone</h1>

    <div id="game-container">
        <div id="inventory">
            <h2>Inventory</h2>
            </div>

        <div id="crafting">
            <h2>Crafting Bench</h2>
            </div>
    </div>

    <div id="result-box">
        Drop two elements into the Crafting Bench to begin!
    </div>

    <script>
        // --- Core Game Constants & Puter.js Setup ---
        const CACHE_KEY = 'infinite_craft_recipes';
        const STARTING_ELEMENTS = ['Earth', 'Fire', 'Water', 'Wind'];
        let ALL_ELEMENTS = new Set(STARTING_ELEMENTS);
        let RECIPE_CACHE = {}; // In-memory cache for speed

        const inventoryEl = document.getElementById('inventory');
        const craftingEl = document.getElementById('crafting');
        const resultEl = document.getElementById('result-box');

        /**
         * The AI "Fusion Engine" logic using Puter.js.
         * Calls the LLM to generate a new element if a combination is new.
         */
        async function runAICombination(first, second) {
            resultEl.textContent = `Combining ${first} + ${second}... AI is thinking! 🧠`;

            // The core Infinite Craft prompt (deterministic combination logic)
            const prompt = `You are the engine behind a game like Infinite Craft. Your job is to combine two words/idioms into a new one. The combinations should look for something that is semantically "in between" the two inputs. For instance "fire" + "water" would yield "steam". Just respond with only the output word, no chit-chat, no thoughts, just the first word that comes to your mind and stop. The inputs are "${first}" and "${second}".`;

            try {
                const response = await puter.ai.chat(prompt, {
                    // Use a fast, low-cost model like gpt-5-nano
                    model: 'gpt-5-nano',
                    // Low temperature for more deterministic/stable results
                    temperature: 0.2,
                    max_tokens: 5, // Keep the response concise
                });

                // Clean up the response from the AI
                let newElement = response.text.trim().replace(/[."]/g, '');

                if (!newElement || newElement.toLowerCase().includes('sorry')) {
                    return 'Nothing';
                }

                return newElement;
            } catch (error) {
                console.error("AI Error:", error);
                return 'ERROR';
            }
        }

        /**
         * Handles the combination of two elements.
         */
        async function craftElements(e1, e2) {
            // Normalize elements to ensure consistent key (e.g., Water|Fire is same as Fire|Water)
            const [first, second] = [e1, e2].sort();
            const pairKey = `${first}|${second}`;

            // 1. Check Cache/Key-Value Store
            if (RECIPE_CACHE[pairKey]) {
                const result = RECIPE_CACHE[pairKey];
                resultEl.textContent = `✨ Discovered! ${first} + ${second} = ${result} (Cached)`;
                return result;
            }

            // 2. AI Generation
            const newElement = await runAICombination(first, second);

            // 3. Update State and Cache
            if (newElement !== 'Nothing' && newElement !== 'ERROR') {
                RECIPE_CACHE[pairKey] = newElement;
                ALL_ELEMENTS.add(newElement);

                // Save the updated cache to Puter's cloud storage
                await puter.kv.set(CACHE_KEY, RECIPE_CACHE);
                
                resultEl.textContent = `🚀 First Discovery! ${first} + ${second} = ${newElement}`;
                
                // Add the new element to the inventory UI
                renderElements();
            } else {
                resultEl.textContent = `❌ Nothing combined with ${first} + ${second}. Try a different pair!`;
            }

            return newElement;
        }

        // --- UI Logic ---

        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.element);
            // Hide the element being dragged
            setTimeout(() => e.target.style.display = 'none', 0); 
        }

        function handleDragEnd(e) {
             // Restore the element being dragged if it wasn't moved to the crafting bench
            if (e.target.parentElement === inventoryEl) {
                e.target.style.display = 'inline-block';
            }
        }
        
        function handleDragOver(e) {
            e.preventDefault(); // Necessary to allow dropping
        }

        async function handleDrop(e) {
            e.preventDefault();
            const data = e.dataTransfer.getData('text/plain');
            
            // 1. Add element to the crafting bench UI
            const element = createElementEl(data, 'crafting');
            craftingEl.appendChild(element);

            // 2. Check for combination
            const currentElements = Array.from(craftingEl.children).map(el => el.dataset.element);

            if (currentElements.length === 2) {
                const [e1, e2] = currentElements;
                await craftElements(e1, e2);
                
                // 3. Clear the crafting bench after combination
                craftingEl.innerHTML = '<h2>Crafting Bench</h2>'; 
            }
        }

        function createElementEl(elementName, type = 'inventory') {
            const el = document.createElement('div');
            el.className = 'element-item';
            el.textContent = elementName;
            el.draggable = true;
            el.dataset.element = elementName;
            el.addEventListener('dragstart', handleDragStart);

            if (type === 'inventory') {
                el.addEventListener('dragend', handleDragEnd);
            }
            
            return el;
        }

        function renderElements() {
            // Clear inventory first
            inventoryEl.innerHTML = '<h2>Inventory</h2>';
            
            // Render all unique discovered elements
            Array.from(ALL_ELEMENTS).sort().forEach(element => {
                inventoryEl.appendChild(createElementEl(element));
            });
        }

        // --- Initialization ---

        async function initializeGame() {
            // 1. Load the recipe cache from Puter.js Key-Value store
            const cachedRecipes = await puter.kv.get(CACHE_KEY);
            if (cachedRecipes) {
                RECIPE_CACHE = cachedRecipes;
            }

            // 2. Build the list of all known elements
            const discoveredElements = new Set(Object.values(RECIPE_CACHE));
            ALL_ELEMENTS = new Set([...STARTING_ELEMENTS, ...discoveredElements]);

            // 3. Set up drag-and-drop listeners
            craftingEl.addEventListener('dragover', handleDragOver);
            craftingEl.addEventListener('drop', handleDrop);
            
            // 4. Render the initial state
            renderElements();

            resultEl.textContent = `Ready! You have discovered ${ALL_ELEMENTS.size} elements.`;
        }

        // Start the game
        initializeGame();
    </script>
</body>
</html>
